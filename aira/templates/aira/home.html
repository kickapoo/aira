{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load aira_extras %}


{% block title %} {% trans "Home" %} - {{user}} {% endblock %}

{% block content %}
    {% menu request.user request.resolver_match.kwargs  request.resolver_match.url_name %} <br>
    {% leaflet_map %}
    {% supervised_users_list request.user  request.resolver_match.kwargs.username %}
    {% agrifields_as_cards object_list %}
{% endblock %}

{% block extrajs %}

<script type="text/javascript">

    var agrifields_list = [
        // queryset list to js array with objects
        {% for agrifield in object_list %}
            {{ agrifield.as_json|safe }} {% if not forloop.last %},{% endif %}
        {% endfor %}
    ]

    function helperSelectedAgrifieldCircle(lat, lng, div, mapid, radius){
        // Minor helper function that behaves as constractor for map
        // call in leaflet_map tag
        var circle = [lat, lng]
        aira.LeafletMap.selectedAgrifieldCircle(
                agrifields_list, div, mapid, [39.15,20.98],
                circle, radius
        );
    };

    // Create a map with user agrifields list
    aira.LeafletMap.createMap('map', agrifields_list, [39.15,20.98], 10, false,[], null);

    // Trash an object with a  conform pop up
    // Class selector
    $(document).on("click", ".trash", function(e) {
         var agrifield_id = ($(this).attr('id'));
         bootbox.confirm({
             title: "{% trans 'aira message' %}",
             message: "<h3 style='padding-left:70px'>{% trans 'Do you want delete this field?' %}</h3>",
             buttons: {
                 confirm: {
                     label: "{% trans  'Yes' %}",
                     className: 'btn btn-success pull-left'
                 },
                 cancel: {
                     label: "{% trans  'No' %}",
                     className: 'btn btn-danger'
                 }
             },
             callback:function(result){
                if (result) {
                    $.ajax({
                        url : "/delete/agrifield/",
                        type : "POST",
                        data : { agrifield_pk: agrifield_id },
                        success : function(response) {
                            $('#card-' + agrifield_id).hide()
                            $.notify("{% trans 'Agrifield deleted' %}");
                        },
                        error : function(xhr,errmsg,err) {
                            console.log(xhr.status + ": " + xhr.responseText);
                        }
                    });
                }
            }
         })
    })
</script>
{% endblock %}
